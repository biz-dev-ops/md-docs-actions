name: md-docs composite action
description: |
  Composite github action to:
    
    1. Install Graphviz;
    1. Install node.js;
    1. Install md-docs cli;
    1. Use md-docs cli to generate a website for every branch;
    1. Deploy the generated website to GitHub pages;

inputs:
  github_token:
    description: Github token generated by the runner.
    required: true
  destination_directory:
    description: Directory where to deploy the generated website. Defaults to empty which is the root.
    required: false
  theme: 
    description: Path to a theme css file.
    required: false
runs:
  using: composite
  steps:
    - name: Setup Graphviz
      uses: ts-graphviz/setup-graphviz@v1

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14.x'

    - name: Install md-docs
      shell: bash
      run: npm install -g @synion/md-docs

    - name: Build branches
      shell: bash
      id: branches
      run: |
        md-docs -b
        BRANCHES=$(cat ./dist/branches.json)
        echo "::set-output name=value::${BRANCHES//'%'/'%25'}"

    - name: Build websites
      shell: bash
      run: |
        git fetch
        for B in $(echo $BRANCHES | jq -r 'sort_by(.path) | .[].name')
        do
            git checkout "$B"
            md-docs -t $THEME -s gh-pages
        done
      env:
        THEME: ${{ inputs.theme }}
        BRANCHES: ${{ steps.branches.outputs.value }}

    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ inputs.github_token }}
        publish_dir: dist
        destination_dir: ${{ inputs.destination_directory }}

    - name: Uninstall md-docs
      shell: bash
      run: npm uninstall -g @synion/md-docs
